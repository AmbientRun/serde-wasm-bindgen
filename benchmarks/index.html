<script src="https://unpkg.com/text-encoding/lib/encoding.js"></script>
<script src="https://unpkg.com/lodash"></script>
<script src="https://unpkg.com/benchmark"></script>
<script src="pkg/serde_wasm_bindgen_benches.js"></script>
<input type="button" id="run" disabled value="Run" />
<pre id="output"></pre>
<script>
	delete WebAssembly.instantiateStreaming;

	const benches = wasm_bindgen('pkg/serde_wasm_bindgen_benches_bg.wasm').then(() => {
		wasm_bindgen.init_console();
		return wasm_bindgen;
	});

	const inputs = ['canada', 'citm_catalog', 'twitter'].map(async input => {
		const res = await fetch(`${input}.json`);
		return {
			input,
			json: await res.json()
		};
	});

	Promise.all([
		benches,
		Promise.all(inputs)
	]).then(([benches, inputs]) => {
		let suite = new Benchmark.Suite();

		for (let { input, json } of inputs) {
			for (const lib of ['serde_json', 'serde_wasm_bindgen']) {
				const func = benches[`parse_${input}_with_${lib}`];
				suite.add(`${input} x ${lib}`, () => func(json));
			}
		}

		run.onclick = () => {
			output.textContent = 'Running...\n';
			run.disabled = true;

			suite.on('error', event => output.textContent = target.error)
			.on('cycle', event => output.textContent += event.target.toString() + '\n')
			.on('complete', event => {
				output.textContent += 'Done!';
				run.disabled = false;
			})
			.run({ async: true });
		};

		run.disabled = false;
	}).catch(err => {
		console.error(err);
		output.textContent = err;
	});
</script>
